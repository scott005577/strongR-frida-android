name: strongR-frida

on:
  schedule:
    - cron: "0 9,21 * * *"
  workflow_dispatch:

jobs:
  check_version:
    runs-on: ubuntu-22.04
    outputs:
      FRIDA_VERSION: ${{ steps.frida.outputs.version }}
      ALREADY_RELEASE: ${{ steps.check.outputs.exists }}

    steps:
      - name: Get latest Frida version
        id: frida
        uses: actions/github-script@v7
        with:
          script: |
            const { data } = await github.repos.getLatestRelease({
              owner: 'frida',
              repo: 'frida'
            })
            core.setOutput('version', data.tag_name)

      - name: Check if release exists
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            try {
              await github.repos.getReleaseByTag({
                owner: process.env.GIT_OWNER,
                repo: process.env.GIT_REPO,
                tag: '${{ steps.frida.outputs.version }}'
              })
              core.setOutput('exists', '1')
            } catch (e) {
              if (e.status === 404) {
                core.setOutput('exists', '0')
              } else {
                throw e
              }
            }
        env:
          GIT_OWNER: ${{ secrets.GIT_OWNER }}
          GIT_REPO: ${{ secrets.GIT_REPO }}

  create_release:
    needs: check_version
    runs-on: ubuntu-22.04
    if: needs.check_version.outputs.ALREADY_RELEASE == '0'

    steps:
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.check_version.outputs.FRIDA_VERSION }}
          name: ${{ needs.check_version.outputs.FRIDA_VERSION }}
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  android_build:
    needs: check_version
    runs-on: ubuntu-22.04

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 18

      - uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: "17"

      - uses: nttld/setup-ndk@v1
        with:
          ndk-version: r25b

      - uses: actions/setup-python@v5
        with:
          python-version: "3.9"

      - name: Install build dependencies
        run: |
          sudo apt update
          sudo apt install -y build-essential ninja-build \
            gcc-multilib g++-multilib \
            libc6-dev libc6-dev-i386 \
            flex bison ruby ruby-dev
          sudo gem install fpm -v 1.11.0 --no-document
          pip install lief graphlib

      - name: Build Frida (Android)
        run: |
          git clone --recurse-submodules https://github.com/frida/frida
          export ANDROID_NDK_ROOT=$ANDROID_NDK_HOME

          for arch in android-arm android-arm64 android-x86 android-x86_64; do
            mkdir build-$arch
            cd build-$arch
            ../frida/configure --host=$arch
            make -j$(nproc)
            cd ..
          done

      - name: Package outputs
        run: |
          for arch in arm arm64 x86 x86_64; do
            gzip build-android-$arch/subprojects/frida-core/server/frida-server
            gzip build-android-$arch/subprojects/frida-core/inject/frida-inject
            gzip build-android-$arch/subprojects/frida-core/lib/gadget/frida-gadget.so
          done

      - name: Upload artifacts to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.check_version.outputs.FRIDA_VERSION }}
          files: |
            build-android-*/subprojects/frida-core/server/frida-server.gz
            build-android-*/subprojects/frida-core/inject/frida-inject.gz
            build-android-*/subprojects/frida-core/lib/gadget/frida-gadget.so.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
